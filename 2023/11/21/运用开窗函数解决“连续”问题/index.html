<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/myfavion.svg"><link rel="icon" href="/img/myfavion.svg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Specialhua"><meta name="keywords" content="学习,编程,想法"><meta name="description" content="学习数据库的过程中，练习题目的时候我们经常会遇到如下等问题：  查询连续三个月都投稿的作者姓名？——期刊表练习题 查询同年连续三个月都有违法记录的当事人信息？——交通执法练习题 用户登录表中连续登录了三次及以上的用户？ 查询产品号存在断号的情况、及断开的号码？  可以看到，以上这些问题似乎都与“连续”相关，又各有不同，例如，第一问仅求解连续三个月有投稿记录，那么如下表格中，当我们把日期升序排序后，"><meta property="og:type" content="article"><meta property="og:title" content="运用开窗函数解决“连续”问题"><meta property="og:url" content="https://inkcodes.com/2023/11/21/%E8%BF%90%E7%94%A8%E5%BC%80%E7%AA%97%E5%87%BD%E6%95%B0%E8%A7%A3%E5%86%B3%E2%80%9C%E8%BF%9E%E7%BB%AD%E2%80%9D%E9%97%AE%E9%A2%98/index.html"><meta property="og:site_name" content="InkCodes"><meta property="og:description" content="学习数据库的过程中，练习题目的时候我们经常会遇到如下等问题：  查询连续三个月都投稿的作者姓名？——期刊表练习题 查询同年连续三个月都有违法记录的当事人信息？——交通执法练习题 用户登录表中连续登录了三次及以上的用户？ 查询产品号存在断号的情况、及断开的号码？  可以看到，以上这些问题似乎都与“连续”相关，又各有不同，例如，第一问仅求解连续三个月有投稿记录，那么如下表格中，当我们把日期升序排序后，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.specialhua.top/hexo_img/wallhaven-6d6mk7.webp"><meta property="article:published_time" content="2023-11-20T18:11:44.000Z"><meta property="article:modified_time" content="2024-11-12T18:11:45.000Z"><meta property="article:author" content="Specialhua"><meta property="article:tag" content="开窗函数"><meta property="article:tag" content="数据库"><meta property="article:tag" content="sql"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.specialhua.top/hexo_img/wallhaven-6d6mk7.webp"><title>运用开窗函数解决“连续”问题 - InkCodes</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="//chinese-fonts-cdn.deno.dev/packages/zqfs/dist/ZhuqueFangsong-Regular/result.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"inkcodes.com",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:40,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/feed.xml" title="InkCodes" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><img src="/img/InkCodes-02.png" alt="InkCodes" class="navbar-logo"> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-bookmark-fill"></i> <span>闲言</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span> </a><a class="dropdown-item" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span> </a><a class="dropdown-item" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></div></li><li class="nav-item"><a class="nav-link" href="/talks/" target="_self"><i class="iconfont icon-slack-fill"></i> <span>碎语</span></a></li><li class="nav-item"><a class="nav-link" href="/books/" target="_self"><i class="iconfont icon-book"></i> <span>书单</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item"><a class="nav-link" href="https://www.boyouquan.com/planet-shuttle/" target="_blank"><i class="iconfont icon-users"></i> <span>穿梭</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn.specialhua.top/hexo_img/wallhaven-6d6mk7.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="运用开窗函数解决“连续”问题"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-11-21 02:11" pubdate>2023年11月21日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 5.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 47 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">运用开窗函数解决“连续”问题</h1><div class="markdown-body"><p>学习数据库的过程中，练习题目的时候我们经常会遇到如下等问题：</p><blockquote><p>查询连续三个月都投稿的作者姓名？——期刊表练习题</p><p>查询同年连续三个月都有违法记录的当事人信息？——交通执法练习题</p><p>用户登录表中连续登录了三次及以上的用户？</p><p>查询产品号存在断号的情况、及断开的号码？</p></blockquote><p>可以看到，以上这些问题似乎都与“连续”相关，又各有不同，例如，第一问仅求解连续三个月有投稿记录，那么如下表格中，当我们把日期升序排序后，第1到3行是满足的，4到5行不满足：</p><table><thead><tr><th>时间</th><th>序号</th></tr></thead><tbody><tr><td>2023-01-03</td><td>1</td></tr><tr><td>2023-02-11</td><td>2</td></tr><tr><td>2023-03-22</td><td>3</td></tr><tr><td>2023-05-24</td><td>1</td></tr><tr><td>2023-06-10</td><td>2</td></tr></tbody></table><p>第二问在此基础上多加了一个“同年”，那么如下表格中只有第3行到5行是满足要求的，类似地，题目还可以换为“同一天连续n个小时”、“同一月连续n天”，甚至两个、三个条件联立，如“同一年同一月同一小时连续n秒”，这里仅以同年连续3个月举例，观察下表的序号与第一个表格有什么区别：</p><table><thead><tr><th>时间</th><th>序号</th></tr></thead><tbody><tr><td>2022-01-03</td><td>1</td></tr><tr><td>2022-02-04</td><td>2</td></tr><tr><td>2023-03-08</td><td>1</td></tr><tr><td>2023-04-02</td><td>2</td></tr><tr><td>2023-05-01</td><td>3</td></tr><tr><td>2023-07-09</td><td>1</td></tr></tbody></table><p>这就对我们产生了启发，我如果能使用教材上简单介绍的<code>row_number</code>(或<code>row_num</code>)，对时间序列进行排序、并新加一列表示排序的话，似乎我们把这个加了排序的新表用一个where条件进行筛选后（比方说，where 序号为1，2，3？）我们就能直观地得到我们想要的结果。那这个思路是否可行呢？</p><h3 id="开窗函数"><a href="#开窗函数" class="headerlink" title="开窗函数"></a>开窗函数</h3><p>关于开窗函数，百度或者谷歌查询后有很多介绍，在这里限于篇幅不作详细介绍，我以自己的理解作直白的解释：</p><h4 id="函数形式"><a href="#函数形式" class="headerlink" title="函数形式"></a>函数形式</h4><p>首先，开窗函数用在sql语句的select 与 from 之间，在我们应试时，能用到的就是：排序+聚合类函数（sum、max、min、avg、count）的升级版+偏移，用于<strong>查询出一列，且是新的一列（原表没有）</strong>，其基本的语法如下(以row_number()为例)：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <br>	<span class="hljs-built_in">row_number</span> () <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> xx <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> xx)<br><span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span>(表名)<br></code></pre></td></tr></table></figure></div><p>我以表格的形式进行说明：</p><table><thead><tr><th>关键字</th><th>作用</th><th>是否可省略</th></tr></thead><tbody><tr><td>over</td><td>告诉数据库，要开窗查询</td><td>×</td></tr><tr><td>partition by</td><td>按…分组</td><td>√</td></tr><tr><td>order by</td><td>按…排序</td><td>聚合类√，排序类×，偏移类×</td></tr></tbody></table><p>这个<code>over</code>就是所谓的“开窗函数”的关键字，要开窗必须跟上这个关键字，<code>partition by</code>为“按…分组”的意思，可省略，具体看你的业务逻辑，因为不分组一样能求和、排序，<code>order by</code>为“按…排序”的意思。只需要记住这有哪些开窗函数（下面会作介绍），及这三个关键字我们就能使用开窗了。</p><blockquote><p>1.在原表的基础上新开一列</p><p>2.新列中，填充的值情况如下：</p><blockquote><p>(1)序号，标明这一行某个数据的排序情况。</p><p>(2)求和、最大、最小、平均值、计数，这一行中，某个值隶属于的“组”中，它们这一组的求和、最大、最小、平均值、计数（结合partition by），其中，sum求和能与order by连用，进行累加</p><p>(3)偏移，新开的一列为原来某一列数据向前偏移一行或多行，或者向后偏移一行或多行</p></blockquote><p>3.新开的列，全部是<strong>“伪列”</strong>，需要再套一层父查询，把查询结果“固定”下来。</p></blockquote><p>以上这些说明，看起来会比较抽象，下面举例的时候可以回来这里对照查看和理解</p><h4 id="开窗函数种类"><a href="#开窗函数种类" class="headerlink" title="开窗函数种类"></a>开窗函数种类</h4><p>Sql server或oracle中开窗函数种类很多，在此仅介绍常用的几个：</p><blockquote><p>以下5个，最常与partition by 连用：</p><p>sum() over()——开窗求和</p><p>max() over()——开窗求最大</p><p>min() over()——开窗求最小</p><p>avg() over()——开窗求平均</p><p>count() over()——开窗计数（注：不能使用distinct）</p></blockquote><hr><blockquote><p>以下3个，为排序函数，最常与partition by + order by 连用：</p><p>row_number() over()——开窗排序，值相同时序号不等</p><p>rank() over()——开窗排序，值相同时序号相等，且下一个值序号跳开</p><p>dense_rank() over()——开窗排序，值相同时序号相等，且下一个值序号连续</p></blockquote><hr><blockquote><p>以下2个，为偏移函数，常与order by 连用，加上partition by可实现组内偏移：</p><p>lag() over()——开窗向后偏移，默认值为lag(某一列,1)，即步长为1，向后偏移一行，即本行显示某一列的上一行值</p><p>lead() over()——开窗向前偏移，默认值为lead(某一列,1)，即步长为1，向前偏移一行，即本行显示某一列的下一行值</p></blockquote><p>例：自行创建表和插入以下数据，进行观察，demo表中第一列为id，第二列为数字num：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> demo(<br>id INT4,<br>num INT4<br>);<br></code></pre></td></tr></table></figure></div><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> demo <span class="hljs-keyword">VALUES</span><br>(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">8</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">5</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">7</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-number">1</span>,<span class="hljs-number">5</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">5</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">20</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">7</span>),(<span class="hljs-number">3</span>,<span class="hljs-number">7</span>),(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>),(<span class="hljs-number">3</span>,<span class="hljs-number">7</span>),(<span class="hljs-number">3</span>,<span class="hljs-number">7</span>),(<span class="hljs-number">3</span>,<span class="hljs-number">9</span>);<br></code></pre></td></tr></table></figure></div><h5 id="以sum-over-为例"><a href="#以sum-over-为例" class="headerlink" title="以sum() over()为例"></a>以sum() over()为例</h5><p>聚合类，求和，partition by以及order by都可以跟，只跟partition by时居多，表示分组求和的意思。</p><p>以下语句、及结果：</p><p>可以完全省略partition by和order by，此时“降维”成普通sum函数，区别仅在于普通聚合函数最后只显示一行求和值。而开窗在每一行后面都添加一列，该列所有值都一样，都是对某列进行求和</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">SUM</span>(num) <span class="hljs-keyword">OVER</span>() sum_num<br><span class="hljs-keyword">FROM</span> DEMO;<br>	<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231101191245161.png" srcset="/img/loading.gif" lazyload alt="image-20231101191245161"></p><p>以下语句、及结果：</p><p>加了partition by以后，可以看到，结果发生变化，按组求和，并把同一组放在一起给你显示，可以看到，<strong>每一行对应的这个开窗值，都是与该组的“属性”相关的，这个属性指的就是：它们之所以都一样，是因为它们同属于一个id，即同一个partition by</strong>，因此当使用下面第二个代码块的语句（使用distinct，使用内嵌视图）就会使结果和普通聚合一模一样。</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">SUM</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) sum_num<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102071248700.png" srcset="/img/loading.gif" lazyload alt="image-20231102071248700"></p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> ID,<br>	sum_num<br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>		<span class="hljs-built_in">SUM</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) sum_num<br>	<span class="hljs-keyword">FROM</span> DEMO<br>);<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102071337708.png" srcset="/img/loading.gif" lazyload alt="image-20231102071337708"></p><p>请自行观察下列语句的执行结果(acc_num取名 accumulate的意思)：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">SUM</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) acc_num<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><h5 id="剩余几个开窗函数（聚合-排序）"><a href="#剩余几个开窗函数（聚合-排序）" class="headerlink" title="剩余几个开窗函数（聚合+排序）"></a>剩余几个开窗函数（聚合+排序）</h5><p>从该max开始，下面几个聚合类+排序我这里统一贴上一个语句，你可以单拿出一个，去试试看同时加分组排序，只要分组、排序中的一个、什么都不要，观察语句结果：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">MAX</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) max_num,<br>	<span class="hljs-built_in">MIN</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) min_num,<br>	<span class="hljs-built_in">AVG</span>(NUM) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) avg_num,<br>	<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID) cnt_num,<br>	<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) rn_num,<br>	<span class="hljs-built_in">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) drk_num,<br>	<span class="hljs-built_in">RANK</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) rk_num<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102075000825.png" srcset="/img/loading.gif" lazyload alt="image-20231102075000825"></p><h5 id="偏移"><a href="#偏移" class="headerlink" title="偏移"></a>偏移</h5><p>lag() over()及lead() over()单独做一个，因为刚才的语句分了组，虽然偏移也支持组内偏移，但可能看起来会不太清晰，观察以下语句的结果：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">lag</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) lag_num,<br>	<span class="hljs-built_in">lag</span>(num,<span class="hljs-number">2</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) lag2_num, <br>	<span class="hljs-built_in">lead</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) lead_num,<br>	<span class="hljs-built_in">lead</span>(num,<span class="hljs-number">2</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) lead2_num<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102080236851.png" srcset="/img/loading.gif" lazyload alt="image-20231102080236851"></p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">lag</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) ctlag_num,<br>	<span class="hljs-built_in">lag</span>(num,<span class="hljs-number">2</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) ctlag2_num, <br>	<span class="hljs-built_in">lead</span>(num) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) ctlead_num,<br>	<span class="hljs-built_in">lead</span>(num,<span class="hljs-number">2</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) ctlead2_num<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102080417481.png" srcset="/img/loading.gif" lazyload alt="image-20231102080417481"></p><p>可以看到，lag(num)或lead(num)只跟order by的时候，新开的这一列是把Num列往后或往前偏移了一行，因此上面第一个语句查询结果中第3列（lag）第1行、第5列（lead）最后一行出现了null值。lag(num,2)带第二个参数的时候，表示步长，就让num列往后偏移了2行，因此第4列前2行都是null值。</p><p>第二个语句中，lag(num)或lead(num)与partition by 和 order by 同时连用时，我们发现组内也可以进行偏移，于是出现了上图中按ID进行分组后的偏移</p><p>更大胆一点，我们可以让lag(num,x)中的步长x嵌套一个子查询：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	<span class="hljs-built_in">lead</span>(num,(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(ID) <span class="hljs-keyword">FROM</span> DEMO)) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> NUM) lead_numxx<br><span class="hljs-keyword">FROM</span> DEMO;<br></code></pre></td></tr></table></figure></div><h3 id="以题目学"><a href="#以题目学" class="headerlink" title="以题目学"></a>以题目学</h3><p>ok了解了开窗的基本概念之后，用题目来看下实际运用：</p><h4 id="1-投稿表题目"><a href="#1-投稿表题目" class="headerlink" title="1.投稿表题目"></a>1.投稿表题目</h4><p>建TGB表语句：（如有请忽略）</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> TGB<br>(<br>    ZZH <span class="hljs-type">character</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    QKH <span class="hljs-type">character</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    TGRQ <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    WZMC <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) ,<br>    SGJG <span class="hljs-type">varchar</span>(<span class="hljs-number">6</span>) , <br>    <span class="hljs-keyword">CONSTRAINT</span> PK_TGB <span class="hljs-keyword">PRIMARY</span> KEY (ZZH, QKH, TGRQ)<br>) ;<br></code></pre></td></tr></table></figure></div><p>插入数据:</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> TGB ( ZZH,QKH,TGRQ,WZMC,SGJG) <span class="hljs-keyword">VALUES</span> <br>(<span class="hljs-string">&#x27;zz01&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2007-06-03 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;信息安全的第二道防线——入侵检测系统&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ),<br>(<span class="hljs-string">&#x27;zz01&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2018-11-02 11:24:00&#x27;</span>,<span class="hljs-string">&#x27;地铁界限系统的研究&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz01&#x27;</span>,<span class="hljs-string">&#x27;qk03&#x27;</span>,<span class="hljs-string">&#x27;2007-07-08 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;浅论教育和谐下的师德建设&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz01&#x27;</span>,<span class="hljs-string">&#x27;qk04&#x27;</span>,<span class="hljs-string">&#x27;2006-03-04 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;对全球化的一种全体化思考&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz02&#x27;</span>,<span class="hljs-string">&#x27;qk01&#x27;</span>,<span class="hljs-string">&#x27;2006-03-01 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;基于VC与Ansys的参数化有限元分析&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz02&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2008-06-09 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;一种基于移动agent技术的分布式数据检索系统的实现&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz03&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2007-08-29 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;无线传感器网络的研究&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz03&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2008-02-01 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;基于Web的考试系统新方案&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz03&#x27;</span>,<span class="hljs-string">&#x27;qk03&#x27;</span>,<span class="hljs-string">&#x27;2007-06-05 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;论高效青年教师师德建设&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz04&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2008-03-09 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;基于J2EE的分布式事务研究&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz04&#x27;</span>,<span class="hljs-string">&#x27;qk05&#x27;</span>,<span class="hljs-string">&#x27;2008-02-05 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;刍议医话&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz06&#x27;</span>,<span class="hljs-string">&#x27;qk01&#x27;</span>,<span class="hljs-string">&#x27;2007-07-08 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;CORBA和Java的结合使用&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz06&#x27;</span>,<span class="hljs-string">&#x27;qk01&#x27;</span>,<span class="hljs-string">&#x27;2008-01-03 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;高速公路通信系统的整合利用初探&#x27;</span>,<span class="hljs-string">&#x27;未通过&#x27;</span> ), <br>(<span class="hljs-string">&#x27;zz06&#x27;</span>,<span class="hljs-string">&#x27;qk02&#x27;</span>,<span class="hljs-string">&#x27;2006-01-26 00:00:00&#x27;</span>,<span class="hljs-string">&#x27;个性化协同学习环境本体的研究&#x27;</span>,<span class="hljs-string">&#x27;通过&#x27;</span> ); <br></code></pre></td></tr></table></figure></div><p>问：<strong>找出投稿表中同一年连续两个月都有投稿记录的作者信息？</strong></p><p>最终要的是“作者信息”，因为原题考了连接查询，即还存在另一个ZZB（作者表），这里就不给了，因为本表中已有了zzh（作者号）的信息，我们能在本表里筛选出来满足条件的结果，那么用一个join就能把另一个表的信息连进来，因此连接查询不是关键，而在于解决连续的问题。</p><p>那我们不管三七二十一，先把窗开一下看看，<code>partition by</code>采用zzh、和year(tgrq)，即要根据同一作者、同一年份去分组，order by采用tgrq升序排列：</p><p>Step 1——</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>    <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> zzh,<span class="hljs-keyword">YEAR</span>(TGRQ) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> TGRQ) rn<br><span class="hljs-keyword">FROM</span> TGB<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102152006206.png" srcset="/img/loading.gif" lazyload alt="image-20231102152006206"></p><p>可以看到，rn一列，已经按我们指定的同一人、同一年、日期升序进行排列，观察一下，可看到zz01在2007年在6月，7月是投过稿的，因此序号标出了1和2、zz03在2007年6月和8月投过稿，也标出了1和2、zz04在2008年2月和3月投过稿，标出了1和2。其他地方如果年份上出现了断开，因此不会出现2。</p><p>现在似乎我们已经知道结果了，是zz01、zz03、zz04么？</p><p>zz03不是，他的6月和8月没连上，但rn依然给到了他1和2。为什么？因为rn只根据日期升序进行了排序，其他全为1的那些“行”，是因为他们根本没有“同年”多次投稿的记录，所以rn只给到了1</p><p>Step 2——</p><p><strong>核心思想</strong>的一步，把投稿日期（TGRQ）在<strong>月份</strong>上<strong>减去</strong>rn，<strong>这一点是运用开窗函数解决连续的核心思想，关键所在</strong></p><p>这里代码块我做了缩进，以美观些，内嵌视图的这个“子查询”其实就是上一步的结果，只不过是把Step 1的结果表作为了from后面的一坨，相当于在上一步基础上又新开出了一列，这一列命名为delta。观察结果：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>    dateadd(<span class="hljs-string">&#x27;month&#x27;</span>,tgrq,<span class="hljs-operator">-</span>rn) delta<br><span class="hljs-keyword">FROM</span> (<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>        <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> zzh,<span class="hljs-keyword">YEAR</span>(TGRQ) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> TGRQ) rn<br>    <span class="hljs-keyword">FROM</span> TGB<br>)<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102170713914.png" srcset="/img/loading.gif" lazyload alt="image-20231102170713914"></p><p>再来关注delta列的情况：</p><blockquote><p>zz01的6月和7月分别减1，2后，都变成了5月</p><p>zz03的6月和8月分别减1，2后，变成了5月和6月</p><p>zz04的2月和3月分别减1，2后，都变成了1月</p></blockquote><p>因为row_number()优秀的“天然连续”，所以作差这一步的思想，是<strong>抹平</strong>某一个序列与自然数列的“差距”，例如：</p><div class="highlight-wrap" data-rel="Clojure"><figure class="iseeu highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs clojure">(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span><span class="hljs-number">9</span>)<br><br>(对应位置作差)<br><br>(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span>)<br></code></pre></td></tr></table></figure></div><p>连续的部分有：</p><p>(1,2,3) &#x3D;&gt; (0,0,0)</p><p>(7,8,9) &#x3D;&gt; (2,2,2)</p><p>非连续的部分：</p><p>(3,5) &#x3D;&gt; (0,1)</p><p>(5,7) &#x3D;&gt; (1,2)</p><p>所以，<strong>日期减去rn后，如果delta相同，就表明连续，且有几个相同的，就连续几次</strong></p><p>Step 3——</p><p>把刚刚Step 2的结果作为内嵌视图，使用一次普通聚合，把zzh作者号选出来，数一下delta有几个，这里还可以显示出开始投稿日期，因为数的是delta为2的有几个，因此trunc掉delta的日、时、分、秒部分，dateadd月份加1，再data_format转为’YYYY-MM’形式</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> zzh 作者号,<br>	date_format(dateadd(<span class="hljs-string">&#x27;mm&#x27;</span>,trunc(delta,<span class="hljs-string">&#x27;month&#x27;</span>),<span class="hljs-number">1</span>),<span class="hljs-string">&#x27;%Y-%m&#x27;</span>) 开始投稿日期,<br>	<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 连续投稿次数<br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>		dateadd(<span class="hljs-string">&#x27;month&#x27;</span>,tgrq,<span class="hljs-operator">-</span>rn) delta<br>	<span class="hljs-keyword">FROM</span> (<br>		<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>			<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> zzh,<span class="hljs-keyword">YEAR</span>(TGRQ) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> TGRQ) rn<br>		<span class="hljs-keyword">FROM</span> TGB<br>	)<br>)<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ZZH,trunc(delta,<span class="hljs-string">&#x27;month&#x27;</span>)<br><span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">=</span><span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102171604058.png" srcset="/img/loading.gif" lazyload alt="image-20231102171604058"></p><p>为什么最后一步不开窗？数delta也可以用count，但总体会套4层代码，且最外层只是用来做where筛选，不太好看而已，代码如下：</p><p>这样也能做，只是最大程度保住了原表的样子（group by因聚合会丢弃很多列信息），但同时也能看到该作者连续投稿月份最早投的是哪个文章，通过与否（意义不是很大）</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span>(<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>		<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> ZZH,date_format(delta,<span class="hljs-string">&#x27;%Y%m&#x27;</span>)) cnt<br>	<span class="hljs-keyword">FROM</span> (<br>		<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>			dateadd(<span class="hljs-string">&#x27;month&#x27;</span>,tgrq,<span class="hljs-operator">-</span>rn) delta<br>		<span class="hljs-keyword">FROM</span> (<br>			<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>				<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> zzh,<span class="hljs-keyword">YEAR</span>(TGRQ) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> TGRQ) rn<br>			<span class="hljs-keyword">FROM</span> TGB<br>		)<br>	)<br>)<span class="hljs-keyword">WHERE</span> cnt<span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> rn<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231102173820356.png" srcset="/img/loading.gif" lazyload alt="image-20231102173820356"></p><h4 id="2-订单表题目"><a href="#2-订单表题目" class="headerlink" title="2.订单表题目"></a>2.订单表题目</h4><p>建DDB（订单表）语句：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> DDB(<br>ddh <span class="hljs-type">char</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> ,      <br>zyh <span class="hljs-type">char</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> ,      <br>khh <span class="hljs-type">char</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> ,      <br>qdrq <span class="hljs-type">date</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> ,        <br>je <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)       <br>);<br></code></pre></td></tr></table></figure></div><p>导入数据：</p><p>这里因为做题的时候给的是excel，且数据较多，这里如没有数据，请自行下载该excel并导入你的数据库：</p><table><thead><tr><th>文件名</th><th>链接</th><th>提取码</th></tr></thead><tbody><tr><td>ddb.xlsx</td><td><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1HzdiUc8YV8Eu7ZvaRmc3kw">https://pan.baidu.com/s/1HzdiUc8YV8Eu7ZvaRmc3kw</a></td><td>6666</td></tr></tbody></table><p>问：<strong>订单表中的订单号应该是连续编号，找出订单表中的订单号是否有重号？重号是什么？</strong></p><p>重号问题，使用开窗函数来做的话，最先想到的是用dense_rank()，因为这个排序函数会让两个相等的值获得一样的排名，观察这个语句在发生重号处的结果：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ddh,<br>    <span class="hljs-built_in">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) rn<br><span class="hljs-keyword">FROM</span> DDB<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231121184320025.png" srcset="/img/loading.gif" lazyload alt="image-20231121184320025"></p><p>可以看到，只需要把第二列排序结果里出现两次及以上的筛选出来，就得到了发生重号的地方</p><p>直接贴上完整的查重语句：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> DDH 订单号,<br>	<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 重复次数<br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> ddh,<br>		<span class="hljs-built_in">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) rn<br>	<span class="hljs-keyword">FROM</span> DDB<br>)<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DDH<br><span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;=</span><span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20230921183634898.png" srcset="/img/loading.gif" lazyload alt="image-20230921183634898"></p><p>可以想见，本题里最多只出现了2次重号，如果使用自连接，确实只需要<code>join</code>一次即可，但如果重号发生很多，使用开窗的这种方式不管重了多少次都可以检测出来。本题也可以用row_number()，但是语句会比dense_rank()复杂，语句贴在下面</p><p>这里最外层用到了lead偏移，思考一下，只偏移一行，能否找出所有重号的行？如果这题里重号的不止2个，而是3个，4个。。，答案是可以，因为作差后，只要重复，那么重号的那部分的下一行，差值都比他小，所以where条件后面一定可以筛出来。最后的结果每个重号有一行，可以推知，该号只重了一次，如果重两次的话，筛选结果里，该号会有两行</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>		<span class="hljs-built_in">lead</span>(new_ddh) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) lag_new_ddh<br>	<span class="hljs-keyword">FROM</span> (<br>		<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>			DDH::<span class="hljs-type">INT</span><span class="hljs-operator">-</span>rn new_ddh<br>		<span class="hljs-keyword">FROM</span> (<br>			<span class="hljs-keyword">SELECT</span> ddh,<br>				<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) rn<br>			<span class="hljs-keyword">FROM</span> DDB<br>		)<br>	)<br>)<span class="hljs-keyword">WHERE</span> new_ddh<span class="hljs-operator">&gt;</span>lag_new_ddh;<br></code></pre></td></tr></table></figure></div><p>问：<strong>订单表中的订单号应该是连续编号，看看订单表中订单号是否存在断号，断号是什么？</strong></p><p>先来思考一下，现在我们已经可以用row_number()生成一个自然序列了，如果用这个自然序列<strong>左连接</strong>订单号，那么存在断号的地方，其肯定会有NULL值，然后再把NULL值筛选出来，这个思路可行么？</p><p>语句如下：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> rn,new_ddh<br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br>	<span class="hljs-keyword">FROM</span> (<br>		<span class="hljs-keyword">SELECT</span> DDH,<br>			<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) rn<br>		<span class="hljs-keyword">FROM</span> DDB) a<br>	<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <br>		(<span class="hljs-keyword">SELECT</span> DDH new_ddh <span class="hljs-keyword">FROM</span> DDB) b <br>		<span class="hljs-keyword">ON</span> a.rn<span class="hljs-operator">=</span>new_ddh<br>)<span class="hljs-keyword">WHERE</span> new_ddh <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;<br></code></pre></td></tr></table></figure></div><p>前面的部分看起来一切OK，但——订单号本来就存在重号、断号的情况，使用row_number()的话，行号必然会小于最大订单号，也就是说会筛漏掉一部分。</p><p>开窗函数中的row_number()是根据原表中有多少行来生成的，所以这里用这种方法的话，我们得自己考虑生成一个自然数列，而且这个数列的最大值只需要等于最大订单号即可，所以这里使用了level和connect by语法：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> LEVEL num <br>	<span class="hljs-keyword">FROM</span> dual<br>	<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> LEVEL<span class="hljs-operator">&lt;=</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">max</span>(ddh::<span class="hljs-type">INT</span>) <span class="hljs-keyword">FROM</span> DDB)) a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <br>	(<span class="hljs-keyword">SELECT</span> DDH::<span class="hljs-type">INT</span> <span class="hljs-keyword">FROM</span> DDB) b<br><span class="hljs-keyword">ON</span> a.num<span class="hljs-operator">=</span>b.ddh<br><span class="hljs-keyword">WHERE</span> ddh <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> num;<br></code></pre></td></tr></table></figure></div><hr><p>对于连续来说，更常用的还是row_number()结合作差，这个题应该怎么解？</p><p>不好的地方：筛选结果为断号的下一个号，只知道断了几个号，但好在思路更通用一些</p><p>这个表的意思：44之前发生了断号，且断了5个号——&gt;应该为39.40,41,42,43</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>	delta<span class="hljs-operator">-</span>lag_delta cnt_empty<br><span class="hljs-keyword">FROM</span> (<br>	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>		<span class="hljs-built_in">lag</span>(delta) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ddh::<span class="hljs-type">INT</span>) lag_delta<br>	<span class="hljs-keyword">FROM</span> (<br>		<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,<br>			DDH<span class="hljs-operator">-</span>rn delta<br>		<span class="hljs-keyword">FROM</span> (<br>			<span class="hljs-keyword">SELECT</span> DDH,<br>				<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DDH::<span class="hljs-type">INT</span>) rn<br>			<span class="hljs-keyword">FROM</span> DDB<br>		)<br>	)<br>)<br><span class="hljs-keyword">WHERE</span> delta<span class="hljs-operator">&gt;</span>lag_delta <span class="hljs-keyword">OR</span> lag_delta <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;<br></code></pre></td></tr></table></figure></div><p><img src="https://cdn.specialhua.top/picgo/image-20231121224102041.png" srcset="/img/loading.gif" lazyload alt="image-20231121224102041"></p><h4 id="3-来个习题吧"><a href="#3-来个习题吧" class="headerlink" title="3.来个习题吧"></a>3.来个习题吧</h4><p>tb_sale_amount为商品数量表，</p><p>good_category——商品类型</p><p>sale_date——销售日期</p><p>amount——销售数量</p><p><strong>问：求占据前90%销售额的商品类型</strong></p><p>输出结果：</p><table><thead><tr><th>good_category</th></tr></thead><tbody><tr><td>1006</td></tr><tr><td>1005</td></tr><tr><td>1003</td></tr></tbody></table><p>表结构：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_sale_amount(<br>    good_category <span class="hljs-type">int</span>,<br>    sale_date <span class="hljs-type">date</span>,<br>    amount <span class="hljs-type">int</span>,<br>    <span class="hljs-keyword">primary</span> key(good_category, sale_date)<br>);<br></code></pre></td></tr></table></figure></div><p>插入数据：</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> tb_sale_amount<br>(good_category, sale_date, amount) <span class="hljs-keyword">values</span><br>(<span class="hljs-number">1003</span>, <span class="hljs-string">&#x27;2022-01-10&#x27;</span>, <span class="hljs-number">264</span>),<br>(<span class="hljs-number">1001</span>, <span class="hljs-string">&#x27;2022-06-01&#x27;</span>, <span class="hljs-number">21</span>),<br>(<span class="hljs-number">1005</span>, <span class="hljs-string">&#x27;2022-06-01&#x27;</span>, <span class="hljs-number">73</span>),<br>(<span class="hljs-number">1002</span>, <span class="hljs-string">&#x27;2022-06-27&#x27;</span>, <span class="hljs-number">44</span>),<br>(<span class="hljs-number">1006</span>, <span class="hljs-string">&#x27;2022-06-27&#x27;</span>, <span class="hljs-number">405</span>),<br>(<span class="hljs-number">1003</span>, <span class="hljs-string">&#x27;2022-09-10&#x27;</span>, <span class="hljs-number">16</span>),<br>(<span class="hljs-number">1005</span>, <span class="hljs-string">&#x27;2022-09-13&#x27;</span>, <span class="hljs-number">72</span>),<br>(<span class="hljs-number">1004</span>, <span class="hljs-string">&#x27;2022-10-01&#x27;</span>, <span class="hljs-number">29</span>),<br>(<span class="hljs-number">1005</span>, <span class="hljs-string">&#x27;2022-10-03&#x27;</span>, <span class="hljs-number">332</span>),<br>(<span class="hljs-number">1001</span>, <span class="hljs-string">&#x27;2022-10-29&#x27;</span>, <span class="hljs-number">10</span>),<br>(<span class="hljs-number">1006</span>, <span class="hljs-string">&#x27;2022-10-29&#x27;</span>, <span class="hljs-number">137</span>),<br>(<span class="hljs-number">1002</span>, <span class="hljs-string">&#x27;2022-12-02&#x27;</span>, <span class="hljs-number">23</span>),<br>(<span class="hljs-number">1007</span>, <span class="hljs-string">&#x27;2022-12-02&#x27;</span>, <span class="hljs-number">19</span>),<br>(<span class="hljs-number">1003</span>, <span class="hljs-string">&#x27;2022-12-02&#x27;</span>, <span class="hljs-number">30</span>),<br>(<span class="hljs-number">1008</span>, <span class="hljs-string">&#x27;2022-12-03&#x27;</span>, <span class="hljs-number">3</span>),<br>(<span class="hljs-number">1009</span>, <span class="hljs-string">&#x27;2022-12-04&#x27;</span>, <span class="hljs-number">1</span>),<br>(<span class="hljs-number">1010</span>, <span class="hljs-string">&#x27;2022-12-05&#x27;</span>, <span class="hljs-number">9</span>),<br>(<span class="hljs-number">1003</span>, <span class="hljs-string">&#x27;2022-12-30&#x27;</span>, <span class="hljs-number">121</span>);<br></code></pre></td></tr></table></figure></div><hr><p>答案</p><p>– step1. 计算每种商品的总销售额，并降序排序</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    good_category,<br>    <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br><span class="hljs-keyword">from</span> tb_sale_amount<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure></div><p>– step2. 求全部商品的总销售额，为了step3求各种商品的占比，需要先求和。注意：求总和时，窗口值既不排序也不进行分组</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    <span class="hljs-operator">*</span>,<br>    <span class="hljs-built_in">sum</span>(good_amount) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> all_amount<br><span class="hljs-keyword">from</span><br>    (<span class="hljs-keyword">select</span><br>        good_category,<br>        <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br>    <span class="hljs-keyword">from</span> tb_sale_amount<br>    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br>    <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span><br>    ) t1;<br></code></pre></td></tr></table></figure></div><p>– step3. 求占比</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    <span class="hljs-operator">*</span>,<br>    good_amount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> all_amount <span class="hljs-keyword">as</span> ratio<br><span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>          <span class="hljs-operator">*</span>,<br>          <span class="hljs-built_in">sum</span>(good_amount) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> all_amount<br>      <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                good_category,<br>                <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br>            <span class="hljs-keyword">from</span> tb_sale_amount<br>            <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br>            <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span><br>            ) <span class="hljs-keyword">as</span> t1<br>      ) t2;<br></code></pre></td></tr></table></figure></div><p>– step4. 求累计占比，注意：求累计值时，一定要进行排序</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    <span class="hljs-operator">*</span>,<br>    <span class="hljs-built_in">sum</span>(ratio) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ratio <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> acc_ratio<br><span class="hljs-keyword">from</span>(<br>    <span class="hljs-keyword">select</span><br>        <span class="hljs-operator">*</span>,<br>        good_amount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> all_amount <span class="hljs-keyword">as</span> ratio<br>    <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>              <span class="hljs-operator">*</span>,<br>              <span class="hljs-built_in">sum</span>(good_amount) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> all_amount<br>            <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                    good_category,<br>                    <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br>                <span class="hljs-keyword">from</span> tb_sale_amount<br>                <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br>                <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span><br>            ) <span class="hljs-keyword">as</span> t1<br>        ) t2<br>    ) t3;<br></code></pre></td></tr></table></figure></div><p>– step5. 求前一行的累计占比</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    <span class="hljs-operator">*</span>,<br>    <span class="hljs-built_in">lag</span>(acc_ratio) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ratio <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> pre_acc_ratio<br><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span><br>         <span class="hljs-operator">*</span>,<br>       <span class="hljs-built_in">sum</span>(ratio) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ratio <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> acc_ratio<br>    <span class="hljs-keyword">from</span>(<br>        <span class="hljs-keyword">select</span><br>            <span class="hljs-operator">*</span>,<br>            good_amount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> all_amount <span class="hljs-keyword">as</span> ratio<br>        <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                  <span class="hljs-operator">*</span>,<br>                  <span class="hljs-built_in">sum</span>(good_amount) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> all_amount<br>              <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                        good_category,<br>                        <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br>                    <span class="hljs-keyword">from</span> tb_sale_amount<br>                    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br>                    <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span><br>                ) t1<br>            ) t2<br>        ) t3<br>    ) t4;<br></code></pre></td></tr></table></figure></div><p>– step6. 过滤</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">from</span> (<br>    <span class="hljs-keyword">select</span><br>    <span class="hljs-operator">*</span>,<br>    <span class="hljs-built_in">lag</span>(acc_ratio) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ratio <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> pre_acc_ratio<br><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span><br>         <span class="hljs-operator">*</span>,<br>       <span class="hljs-built_in">sum</span>(ratio) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ratio <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> acc_ratio<br>     <span class="hljs-keyword">from</span>(<br>        <span class="hljs-keyword">select</span><br>            <span class="hljs-operator">*</span>,<br>            good_amount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> all_amount <span class="hljs-keyword">as</span> ratio<br>        <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                  <span class="hljs-operator">*</span>,<br>                  <span class="hljs-built_in">sum</span>(good_amount) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> all_amount<br>              <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><br>                        good_category,<br>                        <span class="hljs-built_in">sum</span>(amount) <span class="hljs-keyword">as</span> good_amount<br>                    <span class="hljs-keyword">from</span> tb_sale_amount<br>                    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> good_category<br>                    <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> good_amount <span class="hljs-keyword">desc</span><br>                )  t1<br>              ) t2<br>        ) t3<br>    ) t4<br>) t5<br><span class="hljs-keyword">where</span> pre_acc_ratio <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">or</span> pre_acc_ratio <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.90</span>;<br></code></pre></td></tr></table></figure></div><h3 id="关于伪列"><a href="#关于伪列" class="headerlink" title="关于伪列"></a>关于伪列</h3><p>教材上有一个案例，其用到的是rownum</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>,<br>	rownum<br><span class="hljs-keyword">from</span> ddb<br><span class="hljs-keyword">where</span> rownum<span class="hljs-operator">&lt;=</span><span class="hljs-number">10</span><br></code></pre></td></tr></table></figure></div><p>这个语句似乎很好理解，把表里前10行数据拿到了，但为什么下面这个语句拿不到除了第1行以外的数据呢？</p><div class="highlight-wrap" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>,<br>	rownum<br><span class="hljs-keyword">from</span> ddb<br><span class="hljs-keyword">where</span> rownum<span class="hljs-operator">&gt;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></div><p>rownum的生成是在where之前，可以理解为：数据库把表结果筛好，拿出来，在放到你的眼前时，给每一行加了一个行号</p><p>所以上面第一个语句能出结果的原因，是当数据库把第一条记录拿到的时候，给了一个rownum——1，再来看条件：&lt;&#x3D;10，满足？yes——输出</p><p>以此类推，拿到第二条记录，rownum—— 2 —— &lt;&#x3D;10？——输出。。。一直到第10行</p><p>第二个语句：</p><p>第一条记录，rownum—— 1 —— &gt;1？——不输出</p><p>第二条记录，rownum—— 1（注意这里为什么还是给它1） —— &gt;1？——不输出</p><h3 id="其他还可用作练习的题"><a href="#其他还可用作练习的题" class="headerlink" title="其他还可用作练习的题"></a>其他还可用作练习的题</h3><p>以下一些是可以使用开窗函数来解决的、之前做过的题，这里受限于篇幅不再详列数据，可根据题目去找一下原题在哪，看开窗的方法能否帮到你，理论上来说，那些需要使用group by的题目，开窗都可以用，只是实现路径不同</p><p>问：加油站编号的首位代表加油站所在的区域，每个区域的加油站都有加油记录。基于加油表查询哪些加油卡在全部区域都有加油记录，输出卡号。(阶段测验2 补充几个问题.docx)</p><p>问：基于加油卡表查询每天办理的加油卡的卡号是否正常，即卡号的后4位从0001开始，不重复且连续。输出日期和状态（卡号正常、不正常） (阶段测验2 补充几个问题.docx)</p><p>问：统计出哪些单位同一年连续3个月都有订购教材，输出单位信息。（阶段练习3.docx）</p><p>问：统计出哪些单位连续3个月都没有订购教材，输出单位信息。(阶段练习3.docx）</p><p>。。。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>1.求解连续问题，开窗函数优势在于：不论连续多少次，都可以解决</p><p>2.聚合类开窗，sum,min,max,avg,count等等大部分时候语法<strong>不如</strong>普通聚合简洁</p><p>3.由于往往需要根据上一次开窗的结果进行筛选、作差等等，开窗一般需要多层嵌套，代码形式上看起来会比普通连接查询复杂，不必刻意追求代码复杂性来炫技</p><p>4.开窗更像是一种excel思维，结果比group by 等可以保留更多列</p><p>5.开窗函数在解决连续问题上有一定优势，聚合类大部分时候比group by复杂，如果已经能熟练运用连接、group by等，可以把本篇文章讲的内容当作参考</p><p>6.写了那么多，其实就只有一点内容，也就是核心作差的那一步，只是为了讲清楚开窗函数，才理了很多概念内容，搬了很多语句，有点为了造出个轮子，把车身车体搬出来造一遍的意思</p><p>7.不足之处，请多指正</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a> <span>></span> <a href="/categories/%E6%8A%80%E6%9C%AF/%E5%AD%A6%E4%B9%A0/" class="category-chain-item">学习</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%BC%80%E7%AA%97%E5%87%BD%E6%95%B0/" class="print-no-link">#开窗函数</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="print-no-link">#数据库</a> <a href="/tags/sql/" class="print-no-link">#sql</a></div></div><div class="license-box my-3"><div class="license-title"><div>运用开窗函数解决“连续”问题</div><div>https://inkcodes.com/2023/11/21/运用开窗函数解决“连续”问题/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Specialhua</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年11月21日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年11月13日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-cc-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/11/20/%E4%BF%AE%E6%94%B9fluid%E4%B8%BB%E9%A2%98%E7%BD%91%E7%AB%99%E6%A0%87%E9%A2%98%E4%B8%BA%E5%9B%BE%E7%89%87/" title="修改fluid主题网站标题为图片"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">修改fluid主题网站标题为图片</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/10/11/sql%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%BC%80%E7%AA%97%E5%8E%BB%E9%87%8D%E8%AE%A1%E6%95%B0/" title="sql学习笔记——开窗去重计数"><span class="hidden-mobile">sql学习笔记——开窗去重计数</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="waline"></div><script type="text/javascript">Fluid.utils.loadComments("#waline",(function(){Fluid.utils.createCssLink("https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/waline.css"),Fluid.utils.createScript("https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/waline.js",(function(){var i=Object.assign({serverURL:"https://comment.xhua.ink",path:"window.location.pathname",meta:["nick","mail","link"],requiredMeta:["nick"],lang:"zh-CN",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],dark:'html[data-user-color-scheme="dark"]',wordLimit:0,pageSize:10},{el:"#waline",path:window.location.pathname});Waline.init(i),Fluid.utils.waitElementVisible("#waline .vcontent",()=>{var i="#waline .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>